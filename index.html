<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Utility Bill AI Extractor - EMS Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const UtilityBillExtractor = () => {
      const [apiKey, setApiKey] = useState('');
      const [showApiKey, setShowApiKey] = useState(false);
      const [apiKeyValid, setApiKeyValid] = useState(false);
      const [file, setFile] = useState(null);
      const [processing, setProcessing] = useState(false);
      const [jsonOutput, setJsonOutput] = useState(null);
      const [error, setError] = useState(null);
      const [copied, setCopied] = useState(false);
      const [extractionStats, setExtractionStats] = useState(null);

      useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
          window.lucide.createIcons();
        }
      });

      const validateApiKey = (key) => {
        const isValid = key.startsWith('sk-ant-') && key.length > 20;
        setApiKeyValid(isValid);
        return isValid;
      };

      const handleApiKeyChange = (e) => {
        const key = e.target.value;
        setApiKey(key);
        validateApiKey(key);
      };

      const handleFileUpload = async (e) => {
        const uploadedFile = e.target.files[0];
        if (!uploadedFile) return;

        if (uploadedFile.type !== 'application/pdf') {
          setError('Please upload a PDF file');
          return;
        }

        if (!apiKeyValid) {
          setError('Please enter a valid Anthropic API key first');
          return;
        }

        setFile(uploadedFile);
        setError(null);
        setJsonOutput(null);
        setProcessing(true);

        try {
          const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(uploadedFile);
          });

          const response = await fetch('http://localhost:3000/api/extract', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              apiKey: apiKey,
              payload: {
                model: 'claude-sonnet-4-20250514',
                max_tokens: 16000,
                messages: [{
                  role: 'user',
                  content: [{
                    type: 'document',
                    source: {
                      type: 'base64',
                      media_type: 'application/pdf',
                      data: base64Data
                    }
                  }, {
                    type: 'text',
                    text: `You are an AI extraction agent for Energy Management Solutions (EMS) platform.

Extract utility bill data into the EXACT JSON structure below. Extract data for ONE location only.

CRITICAL: Return ONLY valid JSON (no markdown, no explanation).

{
  "ums_bill": {
    "BILL_NBR": "",
    "BILL_RCVD_DATE": "YYYY-MM-DD",
    "INVOICE_DATE": "YYYY-MM-DD",
    "BILL_AMT": 0,
    "PYMT_DUE_DATE": "YYYY-MM-DD",
    "BILL_TYPE": "",
    "SERVICE_FROM_DATE": "YYYY-MM-DD",
    "SERVICE_TO_DATE": "YYYY-MM-DD",
    "BILLING_DAYS": 0
  },
  "ums_bill_meter_lnit": [{
    "METER_NBR": "",
    "START_READING": 0,
    "END_READING": 0,
    "CALCULATED_USAGE": 0,
    "UOM": ""
  }],
  "ums_bill_charge": [{
    "CHARGE_TYPE": "",
    "CT_ITEM_DESC": "",
    "AMOUNT": 0,
    "CURRENCY": ""
  }],
  "account_details": {
    "ACCT_NBR": "",
    "ACCT_NAME": ""
  },
  "site_details": {
    "SERVICE_ADDRESS": {
      "FULL_ADDRESS": ""
    }
  },
  "vendor_details": {
    "ORG_NAME": "",
    "VENDOR_PHONE": ""
  },
  "totals": {
    "TOTAL_AMOUNT": 0,
    "CURRENCY": ""
  }
}`
                  }]
                }]
              }
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            if (response.status === 401) {
              throw new Error('Invalid API key');
            }
            throw new Error(errorData.error?.message || `API error: ${response.status}`);
          }

          const data = await response.json();
          let content = data.content[0].text;

          content = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) content = jsonMatch[0];

          let parsed = JSON.parse(content);

          const stats = {
            meterCount: parsed.ums_bill_meter_lnit?.length || 0,
            chargeCount: parsed.ums_bill_charge?.length || 0,
            totalAmount: parsed.totals?.TOTAL_AMOUNT || 0,
            currency: parsed.totals?.CURRENCY || 'N/A'
          };

          setExtractionStats(stats);
          setJsonOutput(JSON.stringify(parsed, null, 2));
        } catch (err) {
          console.error('Error:', err);
          setError(err.message || 'Failed to extract data');
        } finally {
          setProcessing(false);
        }
      };

      const handleCopy = () => {
        navigator.clipboard.writeText(jsonOutput);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      const handleDownload = () => {
        const blob = new Blob([jsonOutput], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bill_extract_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 p-8">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-2xl shadow-2xl p-8">
              
              <div className="flex items-center gap-4 mb-8">
                <div className="p-3 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl">
                  <i data-lucide="database" className="text-white w-8 h-8"></i>
                </div>
                <div>
                  <h1 className="text-3xl font-bold text-gray-900">Utility Bill AI Extractor</h1>
                  <p className="text-gray-600">EMS Schema-Aligned</p>
                </div>
              </div>

              {!apiKeyValid && (
                <div className="mb-8 p-6 bg-blue-50 border-2 border-indigo-200 rounded-xl">
                  <h3 className="text-lg font-semibold mb-2">Enter Your Anthropic API Key</h3>
                  <input
                    type={showApiKey ? 'text' : 'password'}
                    value={apiKey}
                    onChange={handleApiKeyChange}
                    placeholder="sk-ant-api03-..."
                    className="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg font-mono text-sm"
                  />
                  {apiKey && !apiKeyValid && (
                    <p className="mt-2 text-sm text-red-600">Invalid API key format</p>
                  )}
                </div>
              )}

              {apiKeyValid && !jsonOutput && (
                <div className="mb-8">
                  <label className="block">
                    <div className="border-2 border-dashed border-indigo-300 rounded-xl p-12 text-center hover:border-indigo-500 cursor-pointer">
                      <i data-lucide="upload" className="mx-auto mb-4 text-indigo-600 w-12 h-12"></i>
                      <p className="text-lg font-semibold">{file ? file.name : 'Upload PDF'}</p>
                      <input type="file" accept=".pdf" onChange={handleFileUpload} className="hidden" />
                    </div>
                  </label>
                </div>
              )}

              {processing && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                  <p className="font-semibold text-blue-900">Processing...</p>
                </div>
              )}

              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
                  <p className="font-semibold text-red-900">Error: {error}</p>
                </div>
              )}

              {jsonOutput && (
                <div className="space-y-6">
                  <div className="flex justify-between">
                    <h2 className="text-2xl font-bold">Extraction Complete</h2>
                    <div className="flex gap-3">
                      <button onClick={handleCopy} className="bg-gray-600 text-white px-4 py-2 rounded-lg">
                        {copied ? 'Copied!' : 'Copy'}
                      </button>
                      <button onClick={handleDownload} className="bg-indigo-600 text-white px-4 py-2 rounded-lg">
                        Download
                      </button>
                    </div>
                  </div>
                  <pre className="bg-gray-900 text-green-400 p-6 rounded-lg overflow-auto max-h-96 text-sm">
                    {jsonOutput}
                  </pre>
                  <button onClick={() => { setFile(null); setJsonOutput(null); }} className="w-full bg-gray-100 px-6 py-3 rounded-lg">
                    Extract Another Bill
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<UtilityBillExtractor />, document.getElementById('root'));
  </script>
</body>
</html>
