<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utility Bill AI Extractor - EMS Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide React Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const { Upload, FileText, Download, Copy, CheckCircle, AlertCircle, Loader, Database, Key, Eye, EyeOff } = lucide;

        const UtilityBillExtractor = () => {
            const [apiKey, setApiKey] = useState('');
            const [showApiKey, setShowApiKey] = useState(false);
            const [apiKeyValid, setApiKeyValid] = useState(false);
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);
            const [jsonOutput, setJsonOutput] = useState(null);
            const [error, setError] = useState(null);
            const [copied, setCopied] = useState(false);
            const [extractionStats, setExtractionStats] = useState(null);

            const validateApiKey = (key) => {
                const isValid = key.startsWith('sk-ant-') && key.length > 20;
                setApiKeyValid(isValid);
                return isValid;
            };

            const handleApiKeyChange = (e) => {
                const key = e.target.value;
                setApiKey(key);
                validateApiKey(key);
            };

            const handleFileUpload = async (e) => {
                const uploadedFile = e.target.files[0];
                if (!uploadedFile) return;

                if (uploadedFile.type !== 'application/pdf') {
                    setError('Please upload a PDF file');
                    return;
                }

                if (!apiKeyValid) {
                    setError('Please enter a valid Anthropic API key first');
                    return;
                }

                setFile(uploadedFile);
                setError(null);
                setJsonOutput(null);
                setProcessing(true);

                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = () => reject(new Error('Failed to read file'));
                        reader.readAsDataURL(uploadedFile);
                    });

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 16000,
                            messages: [{
                                role: 'user',
                                content: [{
                                    type: 'document',
                                    source: {
                                        type: 'base64',
                                        media_type: 'application/pdf',
                                        data: base64Data
                                    }
                                }, {
                                    type: 'text',
                                    text: `You are an AI extraction agent for Energy Management Solutions (EMS) platform.

Extract utility bill data into the EXACT JSON structure below. Extract data for ONE location only (first location if multiple).

CRITICAL INSTRUCTIONS:
1. Return ONLY valid JSON (no markdown, no explanation)
2. Use exact field names as shown
3. Extract ALL charges as separate items in the array
4. Include all address types (service, meter, account, vendor, remit)
5. Capture all contact information
6. Get meter readings with dates and types
7. Extract tax details with rates

REQUIRED JSON STRUCTURE:

{
  "ums_bill": {
    "BILL_NBR": "invoice number",
    "BILL_RCVD_DATE": "YYYY-MM-DD",
    "ENTR_DATE": "YYYY-MM-DD",
    "INVOICE_DATE": "YYYY-MM-DD",
    "BILL_AMT": numeric,
    "CURR_BAL": numeric,
    "PYMT_DUE_DATE": "YYYY-MM-DD",
    "BILL_STAT_TYPE_NAME": "status",
    "BILL_TYPE": "utility type",
    "LATEFEES": numeric,
    "PENAL_AMT": numeric,
    "PREV_BILL_AMT": numeric,
    "CURR_CHARGES": numeric,
    "SERVICE_FROM_DATE": "YYYY-MM-DD",
    "SERVICE_TO_DATE": "YYYY-MM-DD",
    "BILLING_DAYS": numeric
  },
  "ums_bill_meter_lnit": [{
    "METER_NBR": "meter number",
    "POINT_OF_DELIVERY": "POD",
    "CONVERSION_FACTOR": numeric,
    "START_READING": numeric,
    "START_READING_DATE": "YYYY-MM-DD",
    "START_READING_TYPE": "actual/estimated",
    "END_READING": numeric,
    "END_READING_DATE": "YYYY-MM-DD",
    "END_READING_TYPE": "actual/estimated",
    "RAW_USAGE": numeric,
    "IMAGE_USAGE": numeric,
    "CALCULATED_USAGE": numeric,
    "UOM": "unit",
    "COMMODITY_TYPE": "type",
    "SERVICE_TYPE": "type",
    "RATE_CLASS": "class"
  }],
  "ums_bill_charge": [{
    "CHARGE_TYPE": "Fixed/Variable/Tax",
    "CHARGE_CATEGORY": "category",
    "CT_ITEM_DESC": "short description",
    "CHARGE_DESCRIPTION": "detailed description",
    "QUANTITY": numeric or null,
    "RATE": numeric,
    "UNIT": "unit",
    "IMAGE_AMOUNT": numeric,
    "AMOUNT": numeric,
    "CURRENCY": "currency code",
    "NOTES": "additional info"
  }],
  "account_details": {
    "ACCT_NBR": "account number",
    "ACCT_NAME": "account name",
    "CUSTOMER_NAME": "customer name",
    "CUSTOMER_TYPE": "type",
    "BLNG_CYCL_TYPE_NAME": "cycle"
  },
  "site_details": {
    "SITE_NBR": "site number",
    "SITE_NAME": "site name",
    "SERVICE_ADDRESS": {
      "STREET": "street",
      "CITY": "city",
      "PROVINCE": "province/state",
      "POSTAL_CODE": "postal code",
      "COUNTRY": "country",
      "FULL_ADDRESS": "complete address"
    },
    "METER_ADDRESS": {
      "STREET": "street",
      "CITY": "city",
      "PROVINCE": "province/state",
      "POSTAL_CODE": "postal code",
      "COUNTRY": "country",
      "FULL_ADDRESS": "complete address"
    },
    "ACCOUNT_ADDRESS": {
      "NAME": "name on account",
      "STREET": "street",
      "CITY": "city",
      "PROVINCE": "province/state",
      "POSTAL_CODE": "postal code",
      "COUNTRY": "country"
    },
    "ACTIVE_FLAG": "Y/N"
  },
  "vendor_details": {
    "ORG_NAME": "vendor name",
    "VENDOR_LEGAL_NAME": "legal name",
    "TRADING_AS": "trading name",
    "TAX_ID": "tax id",
    "GST_NUMBER": "gst number",
    "VENDOR_ADDRESS": {
      "STREET": "street",
      "CITY": "city",
      "PROVINCE": "province/state",
      "POSTAL_CODE": "postal code",
      "COUNTRY": "country"
    },
    "VENDOR_PHONE": "phone",
    "VENDOR_PHONE_HOURS": "hours",
    "VENDOR_WEBSITE": "website",
    "VENDOR_EMAIL": "email",
    "CUSTOMER_CARE_NUMBER": "phone",
    "EMERGENCY_NUMBER": "phone",
    "POINT_OF_CONTACT": {
      "DEPARTMENT": "department",
      "PHONE": "phone",
      "EMAIL": "email"
    }
  },
  "remit_details": {
    "REMIT_TO_NAME": "payee name",
    "REMIT_ADDRESS": {
      "STREET": "street",
      "CITY": "city",
      "PROVINCE": "province/state",
      "POSTAL_CODE": "postal code",
      "COUNTRY": "country"
    },
    "PAYMENT_METHODS": ["method 1", "method 2"]
  },
  "additional_references": {
    "TRANSIT_NUMBER": "number",
    "REFERENCE_NUMBER": "number",
    "METER_IDENTIFIER": "identifier",
    "LOCATION_CODE": "code",
    "PAGE_NUMBERS": [page numbers]
  },
  "usage_comparison": {
    "CURRENT_USAGE": numeric,
    "PREVIOUS_BILL_USAGE": numeric,
    "LAST_YEAR_USAGE": numeric,
    "CHANGE_VS_PREVIOUS": numeric,
    "CHANGE_VS_LAST_YEAR": numeric,
    "UOM": "unit"
  },
  "totals": {
    "TOTAL_GAS_CHARGES": numeric,
    "TOTAL_TAXES": numeric,
    "TOTAL_AMOUNT": numeric,
    "CURRENCY": "currency code"
  }
}

IMPORTANT:
- Extract EVERY charge line item separately
- Use null for missing numeric values
- Use empty string for missing text values
- Dates in YYYY-MM-DD format
- Return ONLY the JSON object, nothing else`
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (response.status === 401) {
                            throw new Error('Invalid API key. Please check your Anthropic API key.');
                        }
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }

                    const data = await response.json();
                    let content = data.content[0].text;

                    content = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) content = jsonMatch[0];

                    let parsed = null;
                    try {
                        parsed = JSON.parse(content);
                    } catch (e) {
                        const lastBrace = content.lastIndexOf('}');
                        if (lastBrace > 0) {
                            let fixed = content.substring(0, lastBrace + 1);
                            parsed = JSON.parse(fixed);
                        }
                    }

                    if (!parsed) throw new Error('Could not parse extraction result');

                    const stats = {
                        meterCount: parsed.ums_bill_meter_lnit?.length || 0,
                        chargeCount: parsed.ums_bill_charge?.length || 0,
                        totalAmount: parsed.totals?.TOTAL_AMOUNT || 0,
                        currency: parsed.totals?.CURRENCY || 'N/A'
                    };

                    setExtractionStats(stats);
                    setJsonOutput(JSON.stringify(parsed, null, 2));

                } catch (err) {
                    console.error('Error:', err);
                    setError(err.message || 'Failed to extract data from PDF');
                } finally {
                    setProcessing(false);
                }
            };

            const handleCopy = () => {
                navigator.clipboard.writeText(jsonOutput);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleDownload = () => {
                const blob = new Blob([jsonOutput], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bill_extract_${new Date().getTime()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8">
                            
                            {/* Header */}
                            <div className="flex items-center gap-4 mb-8">
                                <div className="p-3 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl">
                                    <Database size={32} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">Utility Bill AI Extractor</h1>
                                    <p className="text-gray-600">EMS Schema-Aligned Extraction Agent</p>
                                </div>
                            </div>

                            {/* API Key Input */}
                            {!apiKeyValid && (
                                <div className="mb-8 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-indigo-200 rounded-xl">
                                    <div className="flex items-start gap-4">
                                        <div className="p-2 bg-indigo-600 rounded-lg">
                                            <Key size={24} className="text-white" />
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-gray-900 mb-2">Enter Your Anthropic API Key</h3>
                                            <p className="text-sm text-gray-600 mb-4">
                                                Your API key is stored locally and only used for this session.
                                            </p>
                                            
                                            <div className="relative">
                                                <input
                                                    type={showApiKey ? 'text' : 'password'}
                                                    value={apiKey}
                                                    onChange={handleApiKeyChange}
                                                    placeholder="sk-ant-api03-..."
                                                    className="w-full px-4 py-3 pr-24 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm"
                                                />
                                                <button
                                                    onClick={() => setShowApiKey(!showApiKey)}
                                                    className="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-500 hover:text-gray-700"
                                                >
                                                    {showApiKey ? <EyeOff size={20} /> : <Eye size={20} />}
                                                </button>
                                            </div>

                                            {apiKey && !apiKeyValid && (
                                                <p className="mt-2 text-sm text-red-600 flex items-center gap-2">
                                                    <AlertCircle size={16} />
                                                    Invalid API key format
                                                </p>
                                            )}

                                            <div className="mt-4 p-3 bg-white border border-indigo-200 rounded-lg">
                                                <p className="text-xs text-gray-700 mb-2 font-semibold">Don't have an API key?</p>
                                                <ol className="text-xs text-gray-600 space-y-1">
                                                    <li>1. Go to <a href="https://console.anthropic.com" target="_blank" className="text-indigo-600 hover:underline">console.anthropic.com</a></li>
                                                    <li>2. Create account â†’ API Keys â†’ Create Key</li>
                                                    <li>3. Copy and paste here</li>
                                                </ol>
                                                <p className="text-xs text-gray-500 mt-2">ðŸ’° Free: $5 credits (~15-20 bills)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* API Key Status */}
                            {apiKeyValid && !jsonOutput && (
                                <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <CheckCircle size={20} className="text-green-600" />
                                        <div>
                                            <p className="text-sm font-semibold text-green-900">API Key Connected</p>
                                            <p className="text-xs text-green-700">No rate limits â€¢ Full control</p>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => { setApiKey(''); setApiKeyValid(false); }}
                                        className="text-sm text-green-700 hover:text-green-900 underline"
                                    >
                                        Change Key
                                    </button>
                                </div>
                            )}

                            {/* Upload */}
                            {apiKeyValid && !jsonOutput && (
                                <div className="mb-8">
                                    <label className="block">
                                        <div className="border-2 border-dashed border-indigo-300 rounded-xl p-12 text-center hover:border-indigo-500 transition-colors cursor-pointer bg-gradient-to-br from-indigo-50 to-purple-50">
                                            <Upload size={48} className="mx-auto mb-4 text-indigo-600" />
                                            <p className="text-lg font-semibold text-gray-700 mb-2">
                                                {file ? file.name : 'Upload Utility Bill PDF'}
                                            </p>
                                            <p className="text-sm text-gray-500">Gas, Electric, Water, Telecom bills</p>
                                            <input type="file" accept=".pdf" onChange={handleFileUpload} className="hidden" disabled={processing} />
                                        </div>
                                    </label>
                                </div>
                            )}

                            {/* Processing */}
                            {processing && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                                    <div className="flex items-center gap-4 mb-4">
                                        <Loader size={24} className="text-blue-600 animate-spin" />
                                        <div>
                                            <p className="font-semibold text-blue-900">AI Agent Processing...</p>
                                            <p className="text-sm text-blue-700">Extracting all bill details</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Error */}
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-6 mb-6 flex items-center gap-4">
                                    <AlertCircle size={24} className="text-red-600" />
                                    <div>
                                        <p className="font-semibold text-red-900">Error</p>
                                        <p className="text-sm text-red-700">{error}</p>
                                    </div>
                                </div>
                            )}

                            {/* Results */}
                            {jsonOutput && (
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <CheckCircle size={24} className="text-green-600" />
                                            <h2 className="text-2xl font-bold">Extraction Complete</h2>
                                        </div>
                                        <div className="flex gap-3">
                                            <button onClick={handleCopy} className="flex items-center gap-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                                {copied ? <><CheckCircle size={20} />Copied!</> : <><Copy size={20} />Copy</>}
                                            </button>
                                            <button onClick={handleDownload} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                                <Download size={20} />Download
                                            </button>
                                        </div>
                                    </div>

                                    {extractionStats && (
                                        <div className="grid grid-cols-4 gap-4">
                                            <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                                <p className="text-sm opacity-90">Meters</p>
                                                <p className="text-3xl font-bold">{extractionStats.meterCount}</p>
                                            </div>
                                            <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                                                <p className="text-sm opacity-90">Charges</p>
                                                <p className="text-3xl font-bold">{extractionStats.chargeCount}</p>
                                            </div>
                                            <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg">
                                                <p className="text-sm opacity-90">Amount</p>
                                                <p className="text-2xl font-bold">{extractionStats.totalAmount}</p>
                                            </div>
                                            <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                                                <p className="text-sm opacity-90">Currency</p>
                                                <p className="text-3xl font-bold">{extractionStats.currency}</p>
                                            </div>
                                        </div>
                                    )}

                                    <div className="relative">
                                        <div className="absolute top-3 right-3 bg-gray-800 text-green-400 px-3 py-1 rounded text-xs">EMS Schema</div>
                                        <pre className="bg-gray-900 text-green-400 p-6 rounded-lg overflow-auto max-h-96 text-sm font-mono">{jsonOutput}</pre>
                                    </div>

                                    <button onClick={() => { setFile(null); setJsonOutput(null); setError(null); setExtractionStats(null); }} className="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200">
                                        Extract Another Bill
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<UtilityBillExtractor />, document.getElementById('root'));
    </script>
</body>
</html>
